<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Hoist</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { max-width: 420px; width: 100%; padding: 32px; }
        h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; text-align: center; }
        .subtitle { color: #64748b; margin-bottom: 32px; text-align: center; }
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 4px; }
        input[type="password"] { width: 100%; height: 48px; border: 1px solid #cbd5e1; border-radius: 8px; padding: 0 16px; font-size: 16px; }
        input[type="password"]:focus { outline: none; border-color: #0ea5e9; box-shadow: 0 0 0 3px rgba(14,165,233,0.1); }
        .hint { font-size: 12px; color: #64748b; margin-top: 4px; }
        .status { padding: 16px; border-radius: 8px; margin-bottom: 24px; text-align: center; }
        .status.success { background: #f0fdf4; color: #166534; }
        .status.error { background: #fef2f2; color: #991b1b; }
        .btn { display: block; width: 100%; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 600; text-decoration: none; cursor: pointer; border: none; text-align: center; }
        .btn-primary { background: #0ea5e9; color: #fff; }
        .btn-primary:hover { background: #0284c7; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        .hidden { display: none; }
        .link { display: block; text-align: center; margin-top: 16px; color: #0ea5e9; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hoist</h1>
        <p class="subtitle">Reset Your Password</p>

        <div id="invalid-link" class="status error hidden">
            Invalid reset link. Missing required parameters.
        </div>

        <form id="reset-form">
            <div class="form-group">
                <label for="password">New Password</label>
                <input type="password" id="password" autocomplete="new-password" required>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirm Password</label>
                <input type="password" id="confirm-password" autocomplete="new-password" required>
                <p class="hint">Min 8 characters with uppercase, lowercase, digit, and special character</p>
            </div>

            <div id="form-error" class="status error hidden"></div>

            <button type="submit" id="submit-btn" class="btn btn-primary">Reset Password</button>
        </form>

        <div id="success-section" class="hidden">
            <div class="status success">Your password has been reset successfully!</div>
            <a id="open-app" href="hoist://login" class="btn btn-primary">Open Hoist App</a>
        </div>
    </div>

    <script>
        (function() {
            const params = new URLSearchParams(window.location.search);
            const email = params.get('email');
            const token = params.get('token');

            const form = document.getElementById('reset-form');
            const invalidLink = document.getElementById('invalid-link');
            const formError = document.getElementById('form-error');
            const successSection = document.getElementById('success-section');
            const submitBtn = document.getElementById('submit-btn');

            if (!email || !token) {
                form.classList.add('hidden');
                invalidLink.classList.remove('hidden');
                return;
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                formError.classList.add('hidden');

                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (password !== confirmPassword) {
                    formError.textContent = 'Passwords do not match.';
                    formError.classList.remove('hidden');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Resetting...';

                try {
                    const response = await fetch('/api/users/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, token, newPassword: password })
                    });

                    if (response.ok) {
                        form.classList.add('hidden');
                        successSection.classList.remove('hidden');
                    } else {
                        const data = await response.json().catch(() => null);
                        if (data?.errors) {
                            const messages = Object.values(data.errors).flat();
                            formError.textContent = messages[0] || 'Reset failed.';
                        } else if (data?.message) {
                            formError.textContent = data.message;
                        } else {
                            formError.textContent = 'Password reset failed. The link may have expired.';
                        }
                        formError.classList.remove('hidden');
                    }
                } catch {
                    formError.textContent = 'Unable to reset password. Please try again later.';
                    formError.classList.remove('hidden');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Reset Password';
                }
            });
        })();
    </script>
</body>
</html>
