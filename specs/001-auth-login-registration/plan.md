# Implementation Plan: Authentication, Login & Registration

**Branch**: `001-auth-login-registration` | **Date**: 2026-02-07 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-auth-login-registration/spec.md`

## Summary

Implement a complete authentication system spanning the .NET backend and Expo React Native mobile app. The backend extends ASP.NET Core Identity with custom endpoints for email/password registration (with email verification via SendGrid), Google OAuth token exchange, and password reset. The mobile app provides a modern login screen with email/password login, Google Sign-In, registration, forgot password, and a post-auth landing page. Research decisions favor leveraging existing Identity infrastructure, the backend token exchange pattern for Google OAuth, and `expo-secure-store` for token storage.

## Technical Context

**Language/Version**: C# / .NET 10.0 (backend), TypeScript 5.9 / React Native 0.81 (mobile)
**Primary Dependencies**: ASP.NET Core Identity, MediatR, FluentValidation, EF Core 10 (backend); Expo SDK 54, expo-router 6, expo-auth-session, expo-secure-store (mobile)
**Storage**: SQL Server via EF Core (Aspire-orchestrated container in dev, Testcontainers in tests)
**Testing**: NUnit + Shouldly + Moq + Respawn (backend), Jest + React Native Testing Library (mobile)
**Target Platform**: iOS, Android, Web (mobile); Linux/Windows server (backend)
**Project Type**: Mobile + API
**Performance Goals**: Login < 10s end-to-end, registration < 2 min, 95% emails delivered < 60s
**Constraints**: Bearer token auth (no cookies), no business logic in mobile client
**Scale/Scope**: 8 API endpoints, 5-6 mobile screens, 4 user stories (P1-P4)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Clean Architecture | PASS | Auth endpoints delegate to MediatR commands/queries. SendGrid behind `IEmailSender` interface. Domain layer has no framework deps. |
| II. CQRS via MediatR | PASS | Register, Login, GoogleLogin, VerifyEmail, ForgotPassword, ResetPassword all expressed as Commands through MediatR pipeline. Validation via FluentValidation behaviors. |
| III. Domain-Driven Design | PASS | ApplicationUser extends IdentityUser (audit via Identity). Email verification state transition raises domain events where needed. |
| IV. API-First with Minimal APIs | PASS | All endpoints mapped via `EndpointGroupBase` at `/api/users/*`. OpenAPI spec auto-generated by NSwag. Contract defined in `contracts/auth-api.yaml`. |
| V. Test-Driven Quality | PASS | Unit tests for validators/handlers, functional tests for API flows via CustomWebApplicationFactory + Testcontainers, integration tests for SendGrid/Identity. |
| VI. Fitness Domain Integrity | PASS | Auth is the gateway to all fitness features. No domain-specific data affected. |
| VII. Simplicity and YAGNI | PASS | Leverages built-in Identity token generation (no custom token tables). Fetch-based API client (no Axios). Single OAuth provider (Google only). |
| VIII. Mobile-First with Expo React Native | PASS | Login/registration screens in `src/App/app/` using expo-router file-based routing. Functional components with hooks. Theming via `constants/theme.ts`. No business logic in mobile. |

**Post-Design Re-check**: All 8 principles remain satisfied. No violations identified.

## Project Structure

### Documentation (this feature)

```text
specs/001-auth-login-registration/
├── plan.md              # This file
├── research.md          # Phase 0: 8 research decisions
├── data-model.md        # Phase 1: ApplicationUser extension, entity definitions
├── quickstart.md        # Phase 1: Setup & verification guide
├── contracts/
│   └── auth-api.yaml    # Phase 1: OpenAPI 3.0 spec (8 endpoints)
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```text
src/
├── AppHost/                          # Aspire orchestrator (existing)
│   ├── AppHost.csproj
│   └── Program.cs
├── Domain/                           # Domain layer (minimal changes)
│   └── ...
├── Application/                      # Application layer
│   ├── Common/
│   │   └── Interfaces/
│   │       └── IEmailSender.cs       # NEW — email sending abstraction
│   └── Identity/
│       └── Commands/
│           ├── Register/             # NEW — RegisterCommand + Validator
│           ├── Login/                # NEW — LoginCommand + Validator
│           ├── GoogleLogin/          # NEW — GoogleLoginCommand + Validator
│           ├── VerifyEmail/          # NEW — VerifyEmailCommand
│           ├── ResendVerification/   # NEW — ResendVerificationCommand
│           ├── ForgotPassword/       # NEW — ForgotPasswordCommand
│           └── ResetPassword/        # NEW — ResetPasswordCommand + Validator
├── Infrastructure/
│   ├── Identity/
│   │   └── ApplicationUser.cs        # MODIFY — add FirstName, LastName, Age
│   ├── Data/
│   │   └── Configurations/
│   │       └── ApplicationUserConfiguration.cs  # NEW — EF Core config
│   └── Services/
│       └── SendGridEmailSender.cs    # NEW — IEmailSender implementation
├── Web/
│   ├── Endpoints/
│   │   └── Users.cs                  # MODIFY — add custom auth endpoints
│   └── wwwroot/                      # NEW — web fallback pages for deep links
│       ├── verify-email.html
│       └── reset-password.html
└── App/                              # Expo React Native app
    ├── app/
    │   ├── _layout.tsx               # MODIFY — add auth state management
    │   ├── (auth)/                   # NEW — auth screen group
    │   │   ├── _layout.tsx           # Auth layout
    │   │   ├── login.tsx             # Login screen
    │   │   ├── register.tsx          # Registration screen
    │   │   ├── forgot-password.tsx   # Forgot password screen
    │   │   ├── reset-password.tsx    # Reset password screen (from deep link)
    │   │   └── verify-email.tsx      # Email verification screen (from deep link)
    │   └── (app)/                    # NEW — authenticated screen group
    │       ├── _layout.tsx           # Authenticated layout
    │       └── index.tsx             # Landing page ("Landing Page")
    ├── hooks/
    │   ├── useAuth.ts                # NEW — auth state & token management
    │   └── useApi.ts                 # NEW — fetch wrapper with bearer token
    ├── services/
    │   └── auth.ts                   # NEW — API call functions for auth endpoints
    └── constants/
        └── api.ts                    # NEW — API base URL config

tests/
├── Application.UnitTests/
│   └── Identity/                     # NEW — command handler + validator tests
├── Application.FunctionalTests/
│   └── Identity/                     # NEW — end-to-end API flow tests
├── Domain.UnitTests/                 # No changes expected
└── Infrastructure.IntegrationTests/
    └── Services/                     # NEW — SendGrid integration tests
```

**Structure Decision**: Mobile + API pattern. The backend follows the existing .NET Clean Architecture layout with new feature folders under `Application/Identity/`. The mobile app uses expo-router's file-based routing with `(auth)` and `(app)` route groups for unauthenticated and authenticated flows respectively.

## Complexity Tracking

No constitution violations identified. All design decisions align with the 8 principles.
